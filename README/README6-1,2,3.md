# ìŠ¤í”„ë§ ì…ë¬¸ - ì½”ë“œë¡œ ë°°ìš°ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸, ì›¹ MVC, DB ì ‘ê·¼ ê¸°ìˆ 
 
> ***ìŠ¤í”„ë§ ì›¹ ê°œë°œ ê¸°ì´ˆ - SECTION 6***
>

# 6-1 ìŠ¤í”„ë§ DB ì ‘ê·¼ ê¸°ìˆ 

### ğŸ“H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜

ê°œë°œì´ë‚˜ í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œ ê°€ë³ê³  í¸ë¦¬í•œ DB, ì›¹ í™”ë©´ ì œê³µ

- https://www.h2database.com ì„¤ì¹˜
- h2.bat ì‹¤í–‰
- jdbc:h2:~/test (ìµœì´ˆ í•œë²ˆ)
- ~/test.mv.db íŒŒì¼ ìƒì„± í™•ì¸

<img src="img/JDBC-URL.png"/>

- ì´í›„ì—ëŠ” jdbc URL â‡’ **jdbc:h2:tcp://localhost/~/test** ìˆ˜ì •í•´ì„œ í†°ìº£ì„ í†µí•´ì„œ ì ‘ê·¼

ğŸ“**Member í…Œì´ë¸” ë§Œë“¤ê¸°**

- javaì—ì„œëŠ” long, db ì—ì„œëŠ” bigint
- generated by default as identity â‡’ ê°’ì„ ì„¸íŒ…í•˜ì§€ ì•Šê³  insert í•˜ë©´ dbì—ì„œ ìë™ìœ¼ë¡œ id ê°’ì„ ì±„ì›Œì¤Œ

<img src="img/create-member-table.png"/>

# 6-2 ìˆœìˆ˜ JDBC

ğŸ“**í™˜ê²½ ì„¤ì •**

- build.gradle íŒŒì¼ì— jdbcì™€ h2 ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€

```java
```
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'
```
javaëŠ” dbì™€ ì—°ê²°ë˜ë ¤ë©´ jdbcê°€ í•„ìˆ˜ë¡œ ìˆì–´ì•¼í•¨
```

- application.propertiesì— ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì†ì •ë³´ ì‘ì„±

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
```

MemberRepository ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ [JdbcMemberRepository.java](http://JdbcMemberRepository.java) ìƒì„±**(20ë…„ì „ ê³ ëŒ€ ê°œë°œìë“¤ì˜ ë°©ì‹ì´ë¯€ë¡œ ì°¸ê³ ë§Œ í•˜ê¸°)**

```java
package hello.hellospring.Repository;

import hello.hellospring.domain.Member;
import org.springframework.jdbc.datasource.DataSourceUtils;

import javax.sql.DataSource;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

public class JdbcMemberRepository implements MemberRepository {

    private final DataSource dataSource;

    public JdbcMemberRepository(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Override
    public Member save(Member member) {
        String sql = "insert into member(name) values(?)";

        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql,
                    Statement.RETURN_GENERATED_KEYS);

            pstmt.setString(1, member.getName());
            pstmt.executeUpdate();

            rs = pstmt.getGeneratedKeys();
            
            if (rs.next()) {
                member.setId(rs.getLong(1));
            } else {
                throw new SQLException("id ì¡°íšŒ ì‹¤íŒ¨");
            }
            return member;
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }

    @Override
    public Optional<Member> findById(Long id) {

        String sql = "select * from member where id = ?";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setLong(1, id);
            rs = pstmt.executeQuery();
            if(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return Optional.of(member);
            } else {
                return Optional.empty();
            }
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }

    }

    @Override
    public Optional<Member> findByName(String name) {

        String sql = "select * from member where name = ?";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, name);
            rs = pstmt.executeQuery();
            if(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return Optional.of(member);
            }
            return Optional.empty();
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }

    @Override
    public List<Member> findAll() {

        String sql = "select * from member";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            rs = pstmt.executeQuery();
            List<Member> members = new ArrayList<>();
            while(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                members.add(member);
            }
            return members;
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }

    private Connection getConnection() {
        return DataSourceUtils.getConnection(dataSource);
    }

    private void close(Connection conn, PreparedStatement pstmt, ResultSet rs)
    {
        try {
            if (rs != null) {
                rs.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        try {
            if (pstmt != null) {
                pstmt.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        try {
            if (conn != null) {
                close(conn);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void close(Connection conn) throws SQLException {
        DataSourceUtils.releaseConnection(conn, dataSource);
    }
}
```

- [SpringConfig.java](http://SpringConfig.java) ì„¤ì • ë³€ê²½ìœ¼ë¡œ ìˆ˜ì •ëœ ì½”ë“œ

```java
package hello.hellospring;

import hello.hellospring.Repository.JdbcMemberRepository;
import hello.hellospring.Repository.MemberRepository;
import hello.hellospring.Repository.MemoryMemberRepository;
import hello.hellospring.service.MemberService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;

@Configuration
public class SpringConfig {
// DataSourceëŠ” ë°ì´í„°ë² ì´ìŠ¤ Connectionì„ íšë“í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê°ì²´
    private DataSource dataSource;

    @Autowired
    public SpringConfig(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    // ìŠ¤í”„ë§ ë¹ˆ ë“±ë¡
    @Bean
    public MemberService memberService(){
        return new MemberService(memberRepository());
    }

    @Bean
    public MemberRepository memberRepository(){
        // return new MemoryMemberRepository();

// ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ Connection ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ DataSourceë¥¼ ìƒì„±í•˜ê³  ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë§Œë“¤ì–´ì„œ DIë¥¼ ë°›ì„ ìˆ˜ ìˆìŒ
        return new JdbcMemberRepository(dataSource);
    }
}
```

ìŠ¤í”„ë§ì˜ DIë¥¼ ì‚¬ìš©í•˜ë©´ ê¸°ì¡´ ì½”ë“œë¥¼ ì „í˜€ ì†ëŒ€ì§€ ì•Šê³ , ì„¤ì •ë§Œìœ¼ë¡œ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŒ

- ì›¹ ë¸Œë¼ìš°ì € ì‹¤í–‰

<img src="img/run-web.png"/>

- íšŒì› ê°€ì… í˜ì´ì§€ì— jpaë¼ëŠ” ì´ë¦„ì„ ë“±ë¡

<img src="img/name-join.png"/>

- ì•„ë˜ì™€ ê°™ì´ DBì— ì €ì¥ì´ ì˜ ë˜ì—ˆê³  ìŠ¤í”„ë§ ì„œë²„ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•´ë„ ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë¨

<img src="img/6-2-members-list.png">
<img src="img/6-2-h2-members-list.png">

- í˜„ì¬ êµ¬í˜„ í´ë˜ìŠ¤ ìƒíƒœì™€ ìŠ¤í”„ë§ ì„¤ì • ì´ë¯¸ì§€

<img src="img/repository-state.png"/>

<img src="img/spring-container-state.png"/>

# 6-3 ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸

Testë„ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ DBê¹Œì§€ ì—°ê²°í•´ì„œ ë™ì‘í•˜ëŠ” **í†µí•©í…ŒìŠ¤íŠ¸** ì§„í–‰

ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆí•œí…Œ MemberService, MemberRepositoryë¥¼ ë°›ì•„ì™€ì•¼ í•˜ê³  test í´ë˜ìŠ¤ì´ê¸° ë•Œë¬¸ì— í•„ë“œì—

<aside>
ã€°ï¸ <b>@SpringBootTest</b> : ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ í…ŒìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ì‹¤í–‰

</aside>

<aside>
ã€°ï¸ <b>@Transactional</b> : í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì— í•´ë‹¹ ì–´ë…¸í…Œì´ì…˜ì´ ìˆìœ¼ë©´, í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ì— transactionì„ ë¨¼ì € ì‹¤í–‰í•˜ê³  DBì— ë°ì´í„°ë¥¼ insertí•˜ê³ , í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ rollback
ê·¸ë˜ì„œ <b>dbì— ìˆëŠ” ì‹¤ì œ ë°ì´í„° ë°˜ì˜ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì—ë„ ì›í• í•˜ê²Œ ì‹¤í–‰ë  ìˆ˜ ìˆìŒ</b>ê¸°ì¡´ì— ì‚¬ìš©í–ˆë˜ AfterEach() ë©”ì†Œë“œë¡œ ë°ì´í„°ë¥¼ ì§€ìš°ì§€ ì•Šì•„ë„ ë¨)

</aside>

- [MemberServiceIntegrationTest.java](http://MemberServiceIntegrationTest.java) íšŒì› ì„œë¹„ìŠ¤ ìŠ¤í”¼ë§ í†µí•© í…ŒìŠ¤íŠ¸

```java
`package hello.hellospring.service;

import hello.hellospring.Repository.MemberRepository;
import hello.hellospring.Repository.MemoryMemberRepository;
import hello.hellospring.domain.Member;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

import static org.junit.jupiter.api.Assertions.assertThrows;

@SpringBootTest
@Transactional
class MemberServiceIntegrationTest {
    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;

    // buildì‹œ ì‹¤ì œ ì½”ë“œì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì½”ë“œëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì„œ ì‹¤í–‰í•´ë„ ë¨
    // ë” ì§ê´€ì ìœ¼ë¡œ ì•Œì•„ë³¼ ìˆ˜ ìˆìŒ
    @Test
    void íšŒì›ê°€ì…() {
        // given : ì–´ë–¤ ìƒí™©ì´ ì£¼ì–´ì¡Œì„ ë•Œ
        Member member = new Member();
        member.setName("spring");

        // when : ì‹¤í–‰ í–ˆì„ ë•Œ
        Long saveId = memberService.join(member);

        // then : ì›í•˜ëŠ” ê²°ê³¼ëŠ” ì•„ë˜ ì½”ë“œê°€ ë‚˜ì™€ì•¼ í•¨
        Member findMember = memberService.findOne(saveId).get();
        Assertions.assertThat(member.getName()).isEqualTo(findMember.getName());
    }

    @Test
    public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() {
        // given
        Member member1 = new Member();
        member1.setName("spring");

        Member member2 = new Member();
        member2.setName("spring");
        // when

        memberService.join(member1);
        // ì¤‘ë³µ íšŒì› member2 ê°ì²´ê°€ join í•˜ë ¤ë©´ IllegalStateExceptionì´ í„°ì ¸ì•¼ í•¨
        IllegalStateException e = assertThrows(IllegalStateException.class, () -> memberService.join(member2));
        // ì˜ˆì™¸ ë©”ì‹œì§€ ê²€ì¦
        Assertions.assertThat(e.getMessage()).isEqualTo("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");

        // then
    }
}
```